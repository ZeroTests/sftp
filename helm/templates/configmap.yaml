apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sftp-server.fullname" . }}-config
  labels:
    {{- include "sftp-server.labels" . | nindent 4 }}
data:
  users.conf: |
    {{- range .Values.users }}
    {{- if .password }}
    {{ .username }}:{{ .password }}:1001:1001::/home/{{ .username }}
    {{- else }}
    {{ .username }}:e:1001:1001::/home/{{ .username }}
    {{- end }}
    {{- end }}
  
  {{- if .Values.sshdConfig.enabled }}
  sshd_config: |
    Port {{ .Values.sshdConfig.port }}
    Protocol 2
    HostKey /etc/ssh/ssh_host_rsa_key
    HostKey /etc/ssh/ssh_host_ecdsa_key
    HostKey /etc/ssh/ssh_host_ed25519_key
    
    PasswordAuthentication {{ .Values.sshdConfig.passwordAuthentication | ternary "yes" "no" }}
    PubkeyAuthentication {{ .Values.sshdConfig.pubkeyAuthentication | ternary "yes" "no" }}
    ChallengeResponseAuthentication no
    
    PermitRootLogin {{ .Values.sshdConfig.permitRootLogin | ternary "yes" "no" }}
    StrictModes yes
    MaxAuthTries {{ .Values.sshdConfig.maxAuthTries }}
    MaxSessions {{ .Values.sshdConfig.maxSessions }}
    
    Subsystem sftp internal-sftp
    
    SyslogFacility AUTH
    LogLevel INFO
    
    Match User *
        ForceCommand internal-sftp
        ChrootDirectory /home/%u
        X11Forwarding no
        AllowTcpForwarding no
  {{- end }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sftp-server.fullname" . }}-scripts
  labels:
    {{- include "sftp-server.labels" . | nindent 4 }}
data:
  install-s3fs.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Installing s3fs-fuse ==="
    
    # Detect OS
    if [ -f /etc/os-release ]; then
      . /etc/os-release
      echo "Detected: $NAME $VERSION_ID"
    fi
    
    # Install based on OS
    if [[ "$ID" == "amzn" ]] && [[ "$VERSION_ID" == "2023" ]]; then
      echo "Amazon Linux 2023 detected - compiling s3fs-fuse from source..."
      
      # Install build dependencies
      yum install -y \
        gcc \
        gcc-c++ \
        make \
        automake \
        autoconf \
        libtool \
        pkg-config \
        fuse \
        fuse-devel \
        libcurl-devel \
        libxml2-devel \
        openssl-devel \
        git \
        tar
      
      # Clone and build s3fs-fuse
      cd /tmp
      rm -rf s3fs-fuse
      git clone --depth 1 https://github.com/s3fs-fuse/s3fs-fuse.git
      cd s3fs-fuse
      
      ./autogen.sh
      ./configure --prefix=/usr --with-openssl
      make -j$(nproc)
      make install
      
      # Verify
      s3fs --version
      echo "✓ s3fs-fuse compiled and installed"
      
    elif [[ "$ID" == "amzn" ]] && [[ "$VERSION_ID" == "2" ]]; then
      echo "Amazon Linux 2 detected..."
      amazon-linux-extras install epel -y
      yum install -y s3fs-fuse
      
    else
      echo "Generic Linux detected..."
      yum install -y epel-release || true
      yum install -y s3fs-fuse
    fi
    
    # Final verification
    if ! command -v s3fs &> /dev/null; then
      echo "ERROR: s3fs installation failed"
      exit 1
    fi
    
    echo "✓ s3fs-fuse ready: $(s3fs --version)"

  s3-mount.sh: |
    #!/bin/bash
    set -e
    
    echo "=== S3 Mount Process ==="
    
    BUCKET_NAME="${S3_BUCKET_NAME}"
    AWS_REGION="${AWS_REGION}"
    MOUNT_POINT="${MOUNT_POINT}"
    
    echo "Bucket: $BUCKET_NAME"
    echo "Region: $AWS_REGION"
    echo "Mount: $MOUNT_POINT"
    
    # Verify s3fs is available
    if ! command -v s3fs &> /dev/null; then
      echo "ERROR: s3fs not found"
      exit 1
    fi
    
    # Create directories
    mkdir -p "$MOUNT_POINT"
    mkdir -p /tmp/s3fs-cache
    chmod 755 "$MOUNT_POINT"
    
    # Mount S3 bucket
    echo "Mounting S3 bucket..."
    s3fs "$BUCKET_NAME" "$MOUNT_POINT" \
      -o iam_role=auto \
      -o url=https://s3.${AWS_REGION}.amazonaws.com \
      -o endpoint=${AWS_REGION} \
      -o allow_other \
      -o mp_umask=022 \
      -o uid=1001 \
      -o gid=1001 \
      -o use_cache=/tmp/s3fs-cache \
      -o ensure_diskfree=500 \
      -o multireq_max=5 \
      -o max_stat_cache_size=1000 \
      -o stat_cache_expire=900 \
      -o dbglevel=info \
      -o curldbg
    
    # Verify mount
    sleep 2
    
    if mountpoint -q "$MOUNT_POINT"; then
      echo "✓ S3 bucket mounted successfully"
      df -h "$MOUNT_POINT"
      ls -la "$MOUNT_POINT" || echo "Bucket is empty or inaccessible"
    else
      echo "✗ Mount verification failed"
      mount | grep s3fs || echo "No s3fs mounts found"
      exit 1
    fi

  setup-users.sh: |
    #!/bin/bash
    set -e
    
    echo "=== Setting Up SFTP Users ==="
    
    MOUNT_POINT="${MOUNT_POINT}"
    
    if ! mountpoint -q "$MOUNT_POINT"; then
      echo "ERROR: S3 not mounted at $MOUNT_POINT"
      exit 1
    fi
    
    # Create SSH directory for keys
    mkdir -p /home/.ssh/keys
    chmod 700 /home/.ssh/keys
    
    {{- range .Values.users }}
    echo "Setting up user: {{ .username }}"
    USER_HOME="$MOUNT_POINT/{{ .username }}"
    
    # Create user home directory
    if [ ! -d "$USER_HOME" ]; then
      mkdir -p "$USER_HOME"
      echo "  Created $USER_HOME"
    fi
    
    # Create .ssh directory
    mkdir -p "$USER_HOME/.ssh"
    chmod 700 "$USER_HOME/.ssh"
    
    {{- if .publicKey }}
    # Setup SSH key
    if [ -f "/home/.ssh/keys/{{ .username }}.pub" ]; then
      cp "/home/.ssh/keys/{{ .username }}.pub" "$USER_HOME/.ssh/authorized_keys"
      chmod 600 "$USER_HOME/.ssh/authorized_keys"
      chown 1001:1001 "$USER_HOME/.ssh/authorized_keys"
      echo "  ✓ SSH key configured"
    else
      echo "  ⚠ SSH key not found"
    fi
    {{- else }}
    echo "  Password authentication only"
    {{- end }}
    
    # Set ownership
    chown -R 1001:1001 "$USER_HOME"
    chmod 755 "$USER_HOME"
    
    echo "  ✓ User {{ .username }} ready"
    {{- end }}
    
    echo ""
    echo "=== User Setup Complete ==="
    echo "User directories:"
    ls -la "$MOUNT_POINT/" | grep -v "^total" || echo "No users found"

  healthcheck.sh: |
    #!/bin/bash
    # Health check script
    
    MOUNT_POINT="${MOUNT_POINT:-/mnt/s3}"
    
    # Check if mounted
    if ! mountpoint -q "$MOUNT_POINT"; then
      echo "ERROR: S3 not mounted"
      exit 1
    fi
    
    # Check if writable
    TEST_FILE="$MOUNT_POINT/.healthcheck"
    if echo "ok" > "$TEST_FILE" 2>/dev/null; then
      rm -f "$TEST_FILE"
      echo "OK: S3 mount is healthy"
      exit 0
    else
      echo "ERROR: S3 mount not writable"
      exit 1
    fi